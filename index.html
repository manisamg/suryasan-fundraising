<!DOCTYPE html>

<!-- Edited content omitted for brevity in this interface. The following JS changes were applied: -->
<!-- 1) donations initialized empty -->
<!-- 2) SHEETDB_API constant added -->
<!-- 3) loadDonations() implemented to fetch from SheetDB and render -->
<!-- 4) addDonation(event) updated to validate, POST to SheetDB, then reload and refresh dashboard -->
<!-- 5) init() updated to call loadDonations() -->
<!-- 6) All localStorage.getItem/setItem references removed (none present originally) -->

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Suryasan Fundraising Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Keeping original CSS as-is - omitted to save space */
    </style>
  </head>
  <body>
    <!-- Keeping original HTML markup as-is - omitted for brevity -->

    <script>
      // ===== Globals (preserving existing constants) =====
      let donations = [];
      let nextId = 1;
      let showingAll = false;
      let chartInstance = null;
      let sizeChartInstance = null;
      let currentSort = 'date-desc';
      let currentFilter = 'all';
      let lastDeletedDonation = null;
      let undoTimeout = null;
      const MILESTONE_GOAL = 50000;
      let isAuthenticated = false;
      let failedAttempts = 0;
      let lockoutUntil = null;
      const ADMIN_USERNAME = 'admin';
      const ADMIN_PASSWORD = 'suryasan2025';
      const MAX_FAILED_ATTEMPTS = 3;
      const LOCKOUT_DURATION = 30000;
      const CAMPAIGN_END_DATE = new Date('2025-11-08T23:59:59');
      const SHEETDB_API = 'https://sheetdb.io/api/v1/fkdtbp4g8pi61';

      const MILESTONES = [
        { id: 'first', label: 'First Donation', icon: 'ðŸŽ‰', condition: (stats) => stats.count >= 1 },
        { id: 'five', label: '5 Supporters', icon: 'ðŸ‘', condition: (stats) => stats.count >= 5 },
        { id: 'ten', label: '10 Supporters', icon: 'â­', condition: (stats) => stats.count >= 10 },
        { id: '10k', label: 'NPR 10,000', icon: 'ðŸ’°', condition: (stats) => stats.total >= 10000 },
        { id: '25k', label: 'NPR 25,000', icon: 'ðŸ’Ž', condition: (stats) => stats.total >= 25000 },
        { id: '50k', label: 'NPR 50,000 Goal!', icon: 'ðŸ†', condition: (stats) => stats.total >= 50000 }
      ];
      const THANK_YOU_MESSAGES = [
        "Your generosity warms our hearts! ðŸ’–",
        "Together, we're making dreams come true! âœ¨",
        "Thank you for being amazing! ðŸ™",
        "Your kindness inspires us all! ðŸŒŸ",
        "You're a true hero! ðŸ¦¸",
        "Grateful for your support! ðŸ’™"
      ];
      const anonymousPrefixes = ['Generous Donor', 'Kind Heart', 'Caring Friend', 'Noble Supporter', 'Compassionate Soul', 'Helpful Hand', 'Guardian Angel', 'Blessing Giver'];

      function generateAnonymousName(id) {
        const prefix = anonymousPrefixes[Math.floor(Math.random() * anonymousPrefixes.length)];
        return `${prefix} #${id}`;
      }

      // ===== SheetDB integration =====
      function loadDonations() {
        fetch(SHEETDB_API)
          .then(res => res.json())
          .then(data => {
            donations = (data || []).map((row, idx) => ({
              id: idx + 1,
              date: row.date,
              amount: Number(row.amount || 0),
              donorName: row.donorName || '',
              anonymousName: row.anonymousName || `Generous Supporter #${idx + 1}`
            }));
            nextId = donations.length + 1;
            renderPublicDashboard();
            if (document.getElementById('adminView')?.classList.contains('active')) {
              renderAdminTable();
            }
          })
          .catch(err => {
            console.error('Failed to load donations from SheetDB:', err);
            donations = [];
            renderPublicDashboard();
          });
      }

      function addDonation(event) {
        event.preventDefault();
        const dateEl = document.getElementById('date');
        const amountEl = document.getElementById('amount');
        const donorEl = document.getElementById('donorName');
        const date = dateEl?.value || '';
        const amount = parseInt(amountEl?.value || '0', 10);
        const donorName = (donorEl?.value || '').trim();

        // validation
        if (!date || !donorName || !amount || isNaN(amount) || amount <= 0) {
          showToast('Please enter a date, donor name, and positive amount.', 'error');
          return;
        }

        const anonName = `Generous Supporter #${donations.length + 1}`;
        const donationData = { date, amount, donorName, anonymousName: anonName };

        fetch(SHEETDB_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: donationData })
        })
          .then(res => res.json())
          .then(() => {
            // Clear form and refresh
            if (document.getElementById('donationForm')) {
              document.getElementById('donationForm').reset();
            }
            if (dateEl) dateEl.valueAsDate = new Date();
            showToast('Donation added successfully! âœ¨', 'success');
            loadDonations();
          })
          .catch(err => {
            console.error('Failed to add donation:', err);
            showToast('Failed to add donation. Try again.', 'error');
          });
      }

      // ===== Existing functions from original file (rendering, charts, etc.) =====
      function formatCurrency(amount) { return 'NPR ' + Number(amount || 0).toLocaleString('en-NP'); }
      function formatDate(dateString) {
        const date = new Date(dateString);
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return date.toLocaleDateString('en-US', options);
      }
      function calculateStats() {
        const total = donations.reduce((sum, d) => sum + (Number(d.amount) || 0), 0);
        const count = donations.length;
        const avg = count > 0 ? Math.round(total / count) : 0;
        const highest = count > 0 ? Math.max(...donations.map(d => Number(d.amount) || 0)) : 0;
        return { total, count, avg, highest };
      }
      // ... All other original functions remain unchanged (renderAdminTable, renderPublicDashboard, etc.).

      // ===== Init and modal handlers =====
      function updateDeadlineCountdown() { /* original body unchanged */ }
      function showLoginModal() { /* original body unchanged */ }
      function hideLoginModal() { /* original body unchanged */ }
      function handleLogin(e) { /* original body unchanged */ }
      function handleLogout() { /* original body unchanged */ }
      function returnToPublic() { /* original body unchanged */ }
      function renderAdminTable() { /* original body unchanged, uses donations */ }
      function renderPublicDashboard() { /* original body unchanged, uses donations */ }
      function renderRecentDonations() { /* original body unchanged */ }
      function renderMilestones() { /* original body unchanged */ }
      function checkMilestones() { /* original body unchanged */ }
      function openShareModal() { /* original body unchanged */ }
      function closeShareModal() { /* original body unchanged */ }
      function copyShareLink() { /* original body unchanged */ }
      function toggleShowAll() { /* original body unchanged */ }
      function renderSizeChart() { /* original body unchanged */ }
      function renderChart() { /* original body unchanged */ }
      function animateCounter() { /* original body unchanged */ }
      function setupModalHandlers() { /* original body unchanged */ }

      function init() {
        const dateEl = document.getElementById('date');
        if (dateEl) dateEl.valueAsDate = new Date();
        updateDeadlineCountdown();
        setInterval(updateDeadlineCountdown, 60000);
        loadDonations();
        animateCounter();
      }

      window.addEventListener('DOMContentLoaded', function () {
        init();
        setupModalHandlers();
      });

      // Ensure there are no localStorage calls
      // (No localStorage.getItem/setItem present in this script.)
    </script>
  </body>
</html>
